{
	"info": {
		"_postman_id": "composite-operations-hmac-collection",
		"name": "Composite Operations HMAC",
		"description": "Composite Operations endpoints with HMAC authentication for expert-persons microservice. Includes complex multi-table operations, bulk data operations, and advanced queries.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Composite Person Operations",
			"item": [
				{
					"name": "Get Complete Person Profile",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/{{personId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"{{personId}}"
							]
						},
						"description": "Retrieve complete person profile with all related data (addresses, employment, children, documents, etc.)"
					},
					"response": []
				},
				{
					"name": "Get Complete Person Profile with Include Filter",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/{{personId}}?include=addresses,employment,passports,children",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"{{personId}}"
							],
							"query": [
								{
									"key": "include",
									"value": "addresses,employment,passports,children",
									"description": "Specific data to include in the response"
								}
							]
						},
						"description": "Retrieve person profile with only specified related data"
					},
					"response": []
				},
				{
					"name": "Create Complete Person Profile",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"person\": {\n    \"first_name\": \"John\",\n    \"last_name\": \"Doe\",\n    \"email\": \"john.doe@example.com\",\n    \"date_of_birth\": \"1990-01-15\",\n    \"gender\": \"Male\",\n    \"nationality\": \"US\",\n    \"marital_status\": \"Single\",\n    \"phone_number\": \"+1-555-123-4567\"\n  },\n  \"addresses\": [\n    {\n      \"line1\": \"123 Main Street\",\n      \"line2\": \"Apt 4B\",\n      \"city\": \"New York\",\n      \"state_province\": \"NY\",\n      \"postal_code\": \"10001\",\n      \"country\": \"US\",\n      \"address_type\": \"Home\",\n      \"is_primary\": true\n    }\n  ],\n  \"employment\": [\n    {\n      \"company_name\": \"Tech Solutions Inc.\",\n      \"job_title\": \"Software Engineer\",\n      \"department\": \"Engineering\",\n      \"employment_start_date\": \"2023-01-15\",\n      \"employment_status\": \"Active\",\n      \"is_current\": true\n    }\n  ],\n  \"passports\": [\n    {\n      \"passport_number\": \"123456789\",\n      \"passport_country\": \"US\",\n      \"issue_date\": \"2020-01-15\",\n      \"expiry_date\": \"2030-01-15\",\n      \"is_current\": true,\n      \"is_primary\": true\n    }\n  ]\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite"
							]
						},
						"description": "Create a complete person profile with all related data in a single transaction"
					},
					"response": []
				},
				{
					"name": "Update Complete Person Profile",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"person\": {\n    \"first_name\": \"John\",\n    \"last_name\": \"Smith\",\n    \"email\": \"john.smith@example.com\",\n    \"phone_number\": \"+1-555-123-9999\",\n    \"marital_status\": \"Married\"\n  },\n  \"addresses\": [\n    {\n      \"address_id\": \"{{addressId}}\",\n      \"line1\": \"456 Oak Avenue\",\n      \"city\": \"Los Angeles\",\n      \"state_province\": \"CA\",\n      \"postal_code\": \"90210\",\n      \"country\": \"US\",\n      \"address_type\": \"Home\",\n      \"is_primary\": true\n    }\n  ],\n  \"employment\": [\n    {\n      \"employment_id\": \"{{employmentId}}\",\n      \"job_title\": \"Senior Software Engineer\",\n      \"salary_amount\": 135000,\n      \"employment_status\": \"Active\"\n    }\n  ]\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite/{{personId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"{{personId}}"
							]
						},
						"description": "Update a complete person profile with all related data in a single transaction"
					},
					"response": []
				}
			]
		},
		{
			"name": "Bulk Operations",
			"item": [
				{
					"name": "Bulk Create Persons",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"persons\": [\n    {\n      \"person\": {\n        \"first_name\": \"Alice\",\n        \"last_name\": \"Johnson\",\n        \"email\": \"alice.johnson@example.com\",\n        \"date_of_birth\": \"1985-03-20\",\n        \"gender\": \"Female\",\n        \"nationality\": \"US\"\n      },\n      \"addresses\": [\n        {\n          \"line1\": \"789 Pine Street\",\n          \"city\": \"Chicago\",\n          \"state_province\": \"IL\",\n          \"postal_code\": \"60601\",\n          \"country\": \"US\",\n          \"address_type\": \"Home\",\n          \"is_primary\": true\n        }\n      ]\n    },\n    {\n      \"person\": {\n        \"first_name\": \"Bob\",\n        \"last_name\": \"Wilson\",\n        \"email\": \"bob.wilson@example.com\",\n        \"date_of_birth\": \"1988-07-10\",\n        \"gender\": \"Male\",\n        \"nationality\": \"US\"\n      },\n      \"addresses\": [\n        {\n          \"line1\": \"321 Elm Avenue\",\n          \"city\": \"Miami\",\n          \"state_province\": \"FL\",\n          \"postal_code\": \"33101\",\n          \"country\": \"US\",\n          \"address_type\": \"Home\",\n          \"is_primary\": true\n        }\n      ]\n    }\n  ]\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite/bulk",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"bulk"
							]
						},
						"description": "Create multiple complete person profiles in a single transaction"
					},
					"response": []
				},
				{
					"name": "Bulk Update Persons",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"updates\": [\n    {\n      \"person_id\": \"{{personId}}\",\n      \"person\": {\n        \"phone_number\": \"+1-555-999-0000\",\n        \"marital_status\": \"Married\"\n      }\n    },\n    {\n      \"person_id\": \"{{personId2}}\",\n      \"person\": {\n        \"phone_number\": \"+1-555-888-0000\",\n        \"marital_status\": \"Single\"\n      }\n    }\n  ]\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite/bulk-update",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"bulk-update"
							]
						},
						"description": "Update multiple person profiles in a single transaction"
					},
					"response": []
				},
				{
					"name": "Bulk Delete Persons",
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"person_ids\": [\n    \"{{personId}}\",\n    \"{{personId2}}\",\n    \"{{personId3}}\"\n  ],\n  \"delete_related\": true,\n  \"reason\": \"Bulk cleanup operation\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite/bulk-delete",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"bulk-delete"
							]
						},
						"description": "Soft delete multiple person profiles and their related data in a single transaction"
					},
					"response": []
				}
			]
		},
		{
			"name": "Advanced Queries",
			"item": [
				{
					"name": "Search Persons with Complex Criteria",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"criteria\": {\n    \"person\": {\n      \"nationality\": \"US\",\n      \"age_range\": {\n        \"min\": 25,\n        \"max\": 45\n      },\n      \"marital_status\": [\"Single\", \"Married\"]\n    },\n    \"employment\": {\n      \"is_current\": true,\n      \"company_name\": \"Tech Solutions Inc.\",\n      \"salary_range\": {\n        \"min\": 80000,\n        \"max\": 150000\n      }\n    },\n    \"location\": {\n      \"country\": \"US\",\n      \"states\": [\"NY\", \"CA\", \"TX\"]\n    }\n  },\n  \"include\": [\"addresses\", \"employment\", \"passports\"],\n  \"limit\": 50,\n  \"offset\": 0,\n  \"sort_by\": \"last_name\",\n  \"sort_order\": \"asc\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/persons-composite/search",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"search"
							]
						},
						"description": "Search for persons using complex criteria across multiple tables"
					},
					"response": []
				},
				{
					"name": "Get Persons by Company",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/by-company?company_name=Tech Solutions Inc.&include=employment,addresses",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"by-company"
							],
							"query": [
								{
									"key": "company_name",
									"value": "Tech Solutions Inc.",
									"description": "Company name to filter by"
								},
								{
									"key": "include",
									"value": "employment,addresses",
									"description": "Related data to include"
								}
							]
						},
						"description": "Get all persons employed by a specific company"
					},
					"response": []
				},
				{
					"name": "Get Persons by Location",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/by-location?country=US&state_province=NY&city=New York&include=addresses",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"by-location"
							],
							"query": [
								{
									"key": "country",
									"value": "US",
									"description": "Country to filter by"
								},
								{
									"key": "state_province",
									"value": "NY",
									"description": "State/Province to filter by"
								},
								{
									"key": "city",
									"value": "New York",
									"description": "City to filter by"
								},
								{
									"key": "include",
									"value": "addresses",
									"description": "Related data to include"
								}
							]
						},
						"description": "Get all persons living in a specific location"
					},
					"response": []
				},
				{
					"name": "Get Expiring Documents Report",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/expiring-documents?days=90&document_types=passport,visa&include=passports,permits_visas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"expiring-documents"
							],
							"query": [
								{
									"key": "days",
									"value": "90",
									"description": "Number of days to look ahead"
								},
								{
									"key": "document_types",
									"value": "passport,visa",
									"description": "Types of documents to check"
								},
								{
									"key": "include",
									"value": "passports,permits_visas",
									"description": "Related data to include"
								}
							]
						},
						"description": "Get report of all persons with documents expiring within specified timeframe"
					},
					"response": []
				}
			]
		},
		{
			"name": "Data Analytics",
			"item": [
				{
					"name": "Get Demographics Summary",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/analytics/demographics",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"analytics",
								"demographics"
							]
						},
						"description": "Get demographic summary statistics (age distribution, gender, nationality, etc.)"
					},
					"response": []
				},
				{
					"name": "Get Employment Statistics",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/analytics/employment",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"analytics",
								"employment"
							]
						},
						"description": "Get employment statistics (companies, positions, salary ranges, etc.)"
					},
					"response": []
				},
				{
					"name": "Get Location Distribution",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "x-client-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-signature",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-timestamp",
								"value": "",
								"type": "text"
							},
							{
								"key": "x-tenant-id",
								"value": "",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/persons-composite/analytics/locations",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"persons-composite",
								"analytics",
								"locations"
							]
						},
						"description": "Get geographic distribution of persons by country, state, and city"
					},
					"response": []
				}
			]
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// FINAL WORKING HMAC Authentication Pre-request Script for Expert Global API",
					"const CryptoJS = require('crypto-js');",
					"",
					"const timestamp = Date.now().toString();",
					"pm.environment.set('timestamp', timestamp);",
					"",
					"//const clientId = pm.environment.get('clientId');",
					"//const secretKey = pm.environment.get('clientKey'); // Your environment variable name",
					"//const tenantId = pm.environment.get('tenantId') || 'global';",
					"",
					"const clientId = 'expert-core';",
					"const secretKey = 'jH3E2kK28sD9vL9kqP1sT5qQ7wA3zX2r';",
					"const tenantId = '01958944-0916-78c8-978d-d2707b71e17d';",
					"",
					"console.log('Environment variables:');",
					"console.log('clientId:', clientId);",
					"console.log('secretKey:', secretKey ? 'SET' : 'MISSING');",
					"console.log('tenantId:', tenantId);",
					"",
					"if (!clientId || !secretKey) {",
					"    console.error('Missing clientId or secretKey in environment variables');",
					"    return;",
					"}",
					"",
					"const method = pm.request.method.toLowerCase();",
					"let stringToSign;",
					"",
					"if (['post', 'put', 'patch', 'delete'].includes(method) && ",
					"    pm.request.body && pm.request.body.raw && pm.request.body.raw.length > 0) {",
					"    const body = pm.request.body.raw;",
					"    let bodyObj;",
					"    try {",
					"        bodyObj = JSON.parse(body);",
					"        stringToSign = JSON.stringify(bodyObj) + timestamp;",
					"    } catch (e) {",
					"        stringToSign = body + timestamp;",
					"    }",
					"    console.log('HMAC check via body');",
					"} else {",
					"    // CRITICAL FIX: Server strips /api prefix",
					"    let path = '/' + pm.request.url.path.join('/');",
					"    if (path.startsWith('/api/')) {",
					"        path = path.substring(4); // Remove '/api' prefix",
					"    }",
					"    stringToSign = path.toLowerCase() + timestamp;",
					"    console.log('HMAC check via path (server strips /api):', path);",
					"}",
					"",
					"const signature = CryptoJS.HmacSHA256(stringToSign, secretKey).toString(CryptoJS.enc.Base64);",
					"",
					"console.log('String to sign:', stringToSign);",
					"console.log('Generated signature:', signature);",
					"",
					"// Clear and set headers",
					"pm.request.headers.remove('x-client-id');",
					"pm.request.headers.remove('x-signature');",
					"pm.request.headers.remove('x-timestamp');",
					"pm.request.headers.remove('x-tenant-id');",
					"pm.request.headers.remove('Content-Type');",
					"",
					"pm.request.headers.add({key: 'x-client-id', value: clientId});",
					"pm.request.headers.add({key: 'x-signature', value: signature});",
					"pm.request.headers.add({key: 'x-timestamp', value: timestamp});",
					"pm.request.headers.add({key: 'x-tenant-id', value: tenantId});",
					"pm.request.headers.add({key: 'Content-Type', value: 'application/json'});",
					"",
					"console.log('HMAC headers set:', {",
					"    'x-client-id': clientId,",
					"    'x-timestamp': timestamp,",
					"    'x-tenant-id': tenantId,",
					"    'method': method,",
					"    'stringToSign': stringToSign",
					"});"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "https://expert-api-persons-dev.onrender.com/api",
			"type": "string"
		},
		{
			"key": "clientId",
			"value": "expert-global-dev",
			"type": "string"
		},
		{
			"key": "clientKey",
			"value": "your-secret-key-here",
			"type": "string"
		},
		{
			"key": "tenantId",
			"value": "global",
			"type": "string"
		},
		{
			"key": "personId",
			"value": "123e4567-e89b-12d3-a456-426614174000",
			"type": "string"
		},
		{
			"key": "personId2",
			"value": "123e4567-e89b-12d3-a456-426614174001",
			"type": "string"
		},
		{
			"key": "personId3",
			"value": "123e4567-e89b-12d3-a456-426614174002",
			"type": "string"
		},
		{
			"key": "addressId",
			"value": "123e4567-e89b-12d3-a456-426614174010",
			"type": "string"
		},
		{
			"key": "employmentId",
			"value": "123e4567-e89b-12d3-a456-426614174020",
			"type": "string"
		}
	]
}